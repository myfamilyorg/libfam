#!/bin/sh

# Resolve real project directory (symlink-safe)
SCRIPT_PATH="$0"
while [ -h "$SCRIPT_PATH" ]; do
    DIR="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)"
    SCRIPT_PATH="$(readlink "$SCRIPT_PATH")"
    case "$SCRIPT_PATH" in /*) ;; *) SCRIPT_PATH="$DIR/$SCRIPT_PATH" ;; esac
done
PROJECT_DIR="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)"

# Defaults
: "${CC:=clang}"
: "${BASE_CFLAGS:=}"
: "${VALGRIND:=1}"
: "${FILTER:=*}"
: "${SILENT:=0}"
: "${MEM_TRACKING:=0}"
: "${NO_LTO:=0}"

# Parse options and collect targets
TARGETS=""
for arg in "$@"; do
    case "$arg" in
        all|test|cov|clean|install)
            TARGETS="$TARGETS $arg"
            ;;
        --novalgrind)
            VALGRIND=0
            ;;
        --quick)
            NO_LTO=1
            ;;
        --cc=*)
            CC="${arg#--cc=}"
            ;;
	--cflags=*)
	    BASE_CFLAGS="${arg#--cflags=}"
	    ;;
        --f=*)
            FILTER="${arg#--f=}"
            ;;
        -s|--silent)
            SILENT=1
            ;;
        --mem_tracking)
            MEM_TRACKING=1
            ;;
        help|-h|--help)
            cat <<EOF
Usage: build [target...] [options...]

Targets (in order): all test cov clean install
Examples:
  build clean all
  build test --novalgrind --f=alloc
  build cov --quick

Options: --novalgrind --quick --cc=... --f=... -s --mem_tracking
EOF
            exit 0
            ;;
        *)
            echo "Unknown argument: $arg"
            "$PROJECT_DIR/build" help
            exit 1
            ;;
    esac
done

# Default: if no targets given → just "all"
[ -z "$TARGETS" ] && TARGETS=" all"

# Export everything
export CC CXX VALGRIND FILTER SILENT MEM_TRACKING NO_LTO BASE_CFLAGS
export PROJECT_DIR

# Run each target in order
for t in $TARGETS; do
    case "$t" in
        all)     BUILD_MODE=all     ;;
        test)    BUILD_MODE=test    ;;
        cov)     VALGRIND=0; BUILD_MODE=cov     ;;
        clean)   BUILD_MODE=clean   ;;
        install) BUILD_MODE=install ;;
    esac
    export BUILD_MODE
    echo "→ Running target: $t"
    "$PROJECT_DIR/scripts/targets/$t.sh" || exit $?
done

