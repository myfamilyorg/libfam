/********************************************************************************
 * MIT License
 *
 * Copyright (c) 2025 Christopher Gilliard
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 *
 *******************************************************************************/

#include <libfam/aighthash.h>
#include <libfam/bible.h>
#include <libfam/env.h>
#include <libfam/kem.h>
#include <libfam/limits.h>
#include <libfam/rng.h>
#include <libfam/storm.h>
#include <libfam/string.h>
#include <libfam/test_base.h>
#include <libfam/wots.h>

Test(storm_vectors) {
	StormContext ctx;
	__attribute__((aligned(32))) const u8 SEED[32] = {1, 2, 3};
	__attribute((aligned(32))) u8 buf1[32] = {
	    9,	 93,  216, 137, 224, 212, 105, 200, 163, 28,  146,
	    246, 75,  164, 149, 109, 209, 70,  183, 116, 224, 157,
	    245, 221, 5,   53,	245, 155, 165, 135, 142, 218};
	storm_init(&ctx, SEED);
	storm_next_block(&ctx, buf1);

	u8 exp1[32] = {0,   44, 64, 186, 106, 113, 172, 78,  14,  234, 67,
		       247, 7,	57, 25,	 97,  57,  105, 29,  115, 159, 138,
		       37,  57, 65, 176, 12,  144, 174, 186, 4,	  236};
	ASSERT(!memcmp(buf1, exp1, sizeof(buf1)), "buf1");
	storm_next_block(&ctx, buf1);

	u8 exp2[32] = {210, 174, 13,  100, 187, 212, 168, 128, 197, 235, 213,
		       78,  125, 115, 205, 92,	133, 242, 110, 234, 125, 133,
		       168, 230, 240, 252, 10,	168, 89,  227, 74,  62};

	ASSERT(!memcmp(buf1, exp2, sizeof(buf1)), "buf1 round2");

	__attribute((aligned(32))) u8 buf2[32] = {
	    32, 31, 30, 29, 28, 27, 26, 25, 24, 23, 22, 21, 20, 19, 18, 17,
	    16, 15, 14, 13, 12, 11, 10, 9,  8,	7,  6,	5,  4,	3,  2,	1};
	storm_init(&ctx, SEED);
	storm_next_block(&ctx, buf2);

	u8 exp3[32] = {76,  212, 26,  233, 216, 75,  41,  110, 6,   94,	 20,
		       169, 41,	 185, 138, 213, 219, 243, 79,  197, 109, 50,
		       141, 245, 8,   239, 144, 130, 167, 122, 21,  239};
	ASSERT(!memcmp(buf2, exp3, sizeof(buf2)), "buf2");

	storm_next_block(&ctx, buf2);

	u8 exp4[32] = {162, 251, 154, 18,  139, 107, 17,  243, 220, 138, 196,
		       181, 69,	 163, 85,  123, 226, 16,  149, 98,  13,	 154,
		       218, 24,	 241, 200, 137, 0,   247, 150, 246, 123};
	ASSERT(!memcmp(buf2, exp4, sizeof(buf2)), "buf2 round2");
}

Test(storm_cipher) {
	StormContext ctx;
	__attribute__((aligned(32))) const u8 SEED[32] = {1, 2, 3};
	__attribute__((aligned(32))) u8 buffer1[32] = {0};
	__attribute__((aligned(32))) u8 buffer2[32] = {0};
	__attribute__((aligned(32))) u8 buffer3[32] = {0};
	__attribute__((aligned(32))) u8 buffer4[32] = {0};
	__attribute__((aligned(32))) u8 buffer5[32] = {0};

	storm_init(&ctx, SEED);
	faststrcpy(buffer1, "test1");
	storm_xcrypt_buffer(&ctx, buffer1);
	faststrcpy(buffer2, "test2");
	storm_xcrypt_buffer(&ctx, buffer2);
	faststrcpy(buffer3, "blahblah");
	storm_xcrypt_buffer(&ctx, buffer3);
	faststrcpy(buffer4, "ok");
	storm_xcrypt_buffer(&ctx, buffer4);
	faststrcpy(buffer5, "x");
	storm_xcrypt_buffer(&ctx, buffer5);

	ASSERT(memcmp(buffer1, "test1", 5), "ne1");
	ASSERT(memcmp(buffer2, "test2", 5), "ne2");
	ASSERT(memcmp(buffer3, "blahblah", 8), "ne3");
	ASSERT(memcmp(buffer4, "ok", 2), "ne4");
	ASSERT(memcmp(buffer5, "x", 1), "ne5");

	StormContext ctx2;
	storm_init(&ctx2, SEED);

	storm_xcrypt_buffer(&ctx2, buffer1);
	ASSERT(!memcmp(buffer1, "test1", 5), "eq1");
	storm_xcrypt_buffer(&ctx2, buffer2);
	ASSERT(!memcmp(buffer2, "test2", 5), "eq2");

	storm_xcrypt_buffer(&ctx2, buffer3);
	ASSERT(!memcmp(buffer3, "blahblah", 8), "eq3");

	storm_xcrypt_buffer(&ctx2, buffer4);
	ASSERT(!memcmp(buffer4, "ok", 2), "eq4");

	storm_xcrypt_buffer(&ctx2, buffer5);
	ASSERT(!memcmp(buffer5, "x", 1), "eq5");
}

Test(storm_cipher_vector) {
	StormContext ctx;
	__attribute__((aligned(32))) const u8 SEED[32] = {1, 2, 3};
	__attribute__((aligned(32))) u8 buffer1[32] = {0};
	__attribute__((aligned(32))) u8 buffer2[32] = {0};

	storm_init(&ctx, SEED);
	faststrcpy(buffer1, "test1");
	storm_xcrypt_buffer(&ctx, buffer1);
	faststrcpy(buffer2, "test2");
	storm_xcrypt_buffer(&ctx, buffer2);

	u8 expected1[32] = {208, 219, 23,  2,	102, 98,  157, 53,
			    88,	 199, 188, 237, 126, 195, 16,  183,
			    63,	 14,  194, 187, 89,  153, 201, 245,
			    3,	 242, 121, 53,	200, 243, 205, 126};
	ASSERT(!memcmp(buffer1, expected1, 32), "expected1");
	u8 expected2[32] = {161, 153, 144, 19,	202, 43,  81,  154,
			    83,	 150, 76,  209, 103, 85,  1,   74,
			    116, 231, 230, 62,	23,  126, 208, 173,
			    13,	 252, 88,  139, 176, 20,  42,  167};
	ASSERT(!memcmp(buffer2, expected2, 32), "expected2");
}

#define STORM_COUNT (1000000000 / 32)
static __attribute__((aligned(32))) u8 ZERO_SEED[32] = {0};
static __attribute__((aligned(32))) u8 ONE_SEED[32] = {1};
static __attribute__((aligned(32))) u8 TWO_SEED[32] = {2};
static __attribute__((aligned(32))) u8 THREE_SEED[32] = {3};
static __attribute__((aligned(32))) u8 FOUR_SEED[32] = {4};
static __attribute__((aligned(32))) u8 FIVE_SEED[32] = {5};

Bench(storm) {
	i64 timer;
	__attribute__((aligned(32))) u8 buf1[64] = {0};
	__attribute__((aligned(32))) u8 buf2[64] = {0};
	__attribute__((aligned(32))) u8 buf3[64] = {0};
	__attribute__((aligned(32))) u8 buf4[64] = {0};
	__attribute__((aligned(32))) u8 buf5[64] = {0};
	__attribute__((aligned(32))) u8 buf6[64] = {0};

	StormContext ctx1;
	StormContext ctx2;
	StormContext ctx3;
	StormContext ctx4;
	StormContext ctx5;
	StormContext ctx6;

	storm_init(&ctx1, ZERO_SEED);
	storm_init(&ctx2, ONE_SEED);
	storm_init(&ctx3, TWO_SEED);
	storm_init(&ctx4, THREE_SEED);
	storm_init(&ctx5, FOUR_SEED);
	storm_init(&ctx6, FIVE_SEED);

	timer = micros();
	for (u32 i = 0; i < STORM_COUNT; i++) {
		u8* block1 = buf1 + (i & 32);
		u8* block2 = buf2 + (i & 32);
		u8* block3 = buf3 + (i & 32);
		u8* block4 = buf4 + (i & 32);
		u8* block5 = buf5 + (i & 32);
		u8* block6 = buf6 + (i & 32);

		storm_xcrypt_buffer(&ctx1, block1);
		storm_xcrypt_buffer(&ctx2, block2);
		storm_xcrypt_buffer(&ctx3, block3);
		storm_xcrypt_buffer(&ctx4, block4);
		storm_xcrypt_buffer(&ctx5, block5);
		storm_xcrypt_buffer(&ctx6, block6);
	}
	timer = micros() - timer;

	pwrite(2, "time=", 5, 0);
	write_num(2, timer);
	pwrite(2, ",avg=", 5, 0);
	write_num(2, (timer * 1000) / STORM_COUNT);
	pwrite(2, "ns\n", 3, 0);
}

Test(rng) {
	u64 x = 0, y = 0;
	__attribute__((aligned(32))) u8 z[64] = {0};
	Rng rng;
	__attribute__((aligned(32))) u8 key[32] = {5, 5, 5, 5};
	rng_init(&rng);
	rng_gen(&rng, &x, sizeof(x));
	rng_init(&rng);
	rng_gen(&rng, &y, sizeof(y));
	ASSERT(x != y, "x!=y");

	rng_test_seed(&rng, key);
	rng_gen(&rng, z, sizeof(z));

	u8 expected[64] = {
	    241, 172, 79,  71,	20,  35,  84,  2,   39,	 165, 18,  232, 21,
	    84,	 178, 57,  205, 39,  187, 146, 20,  199, 114, 41,  245, 137,
	    175, 6,   181, 187, 130, 62,  195, 118, 94,	 242, 150, 45,	156,
	    18,	 240, 207, 220, 197, 36,  154, 149, 82,	 140, 108, 33,	154,
	    30,	 22,  146, 169, 199, 72,  2,   124, 117, 60,  141, 191};
	ASSERT_EQ(memcmp(z, expected, 64), 0, "z");
}

#define RNG_BYTES (32 * 1000000ULL)

Bench(rngpf) {
	u8 fbuf[1024] = {0};
	__attribute__((aligned(32))) u8 buffer1[32] = {0};
	__attribute__((aligned(32))) u8 buffer2[32] = {0};
	__attribute__((aligned(32))) u8 buffer3[32] = {0};
	__attribute__((aligned(32))) u8 buffer4[32] = {0};
	__attribute__((aligned(32))) u8 buffer5[32] = {0};
	__attribute__((aligned(32))) u8 buffer6[32] = {0};

	i64 needed = RNG_BYTES;
	Rng rng1, rng2, rng3, rng4, rng5, rng6;
	u64 total_cycles = 0;

	rng_init(&rng1);
	rng_init(&rng2);
	rng_init(&rng3);
	rng_init(&rng4);
	rng_init(&rng5);
	rng_init(&rng6);

	while (needed > 0) {
		u64 start;
		start = cycle_counter();
		rng_gen(&rng1, buffer1, 32);
		rng_gen(&rng2, buffer2, 32);
		rng_gen(&rng3, buffer3, 32);
		rng_gen(&rng4, buffer4, 32);
		rng_gen(&rng5, buffer5, 32);
		rng_gen(&rng6, buffer6, 32);
		total_cycles += cycle_counter() - start;

		needed -= 32;
	}
	const u8 msg[] = "cycles_per_byte=";
	pwrite(2, msg, strlen(msg), 0);
	f64_to_string(fbuf,
		      (f64)(total_cycles * 100 / (6 * RNG_BYTES)) / (f64)100, 2,
		      false);
	pwrite(2, fbuf, strlen(fbuf), 0);
	pwrite(2, "\n", 1, 0);
}

Test(aighthash) {
	u32 v1, v2, v3;

	v1 = aighthash32("11111111abc", 11, 0);
	v2 = aighthash32("11111111abc\0", 12, 0);
	v3 = aighthash32("11111111abc", 11, 0);
	ASSERT(v1 != v2, "v1 != v2");
	ASSERT(v1 == v3, "v1 == v3");

	u64 h1, h2, h3;

	h1 = aighthash64("XXXXXXXXXXXXXXXXxyz", 19, 0);
	h2 = aighthash64("XXXXXXXXXXXXXXXXxyz\0", 20, 0);
	h3 = aighthash64("XXXXXXXXXXXXXXXXxyz", 19, 0);
	ASSERT(h1 != h2, "h1 != h2");
	ASSERT(h1 == h3, "h1 == h3");
}

Test(wots) {
	__attribute__((aligned(32))) u8 key[32] = {1, 2, 3, 4, 5};
	WotsPubKey pk;
	WotsSecKey sk;
	WotsSig sig;
	u8 msg[32] = {9, 9, 9, 9, 9, 4};

	wots_keyfrom(key, &pk, &sk);
	wots_sign(&sk, msg, &sig);
	ASSERT(!wots_verify(&pk, &sig, msg), "verify");
	msg[0]++;
	ASSERT(wots_verify(&pk, &sig, msg), "!verify");
}

#define WOTS_COUNT 1000

Bench(wotsp) {
	__attribute__((aligned(32))) u8 key[32] = {0};
	__attribute__((aligned(32))) u8 msg[32] = {0};
	WotsPubKey pk;
	WotsSecKey sk;
	WotsSig sig;

	Rng rng;
	u64 keygen_sum = 0;
	u64 sign_sum = 0;
	u64 verify_sum = 0;

	rng_init(&rng);

	for (u32 i = 0; i < WOTS_COUNT; i++) {
		rng_gen(&rng, key, 32);
		rng_gen(&rng, msg, 32);

		u64 start = cycle_counter();
		wots_keyfrom(key, &pk, &sk);
		keygen_sum += cycle_counter() - start;
		start = cycle_counter();
		wots_sign(&sk, msg, &sig);
		sign_sum += cycle_counter() - start;
		start = cycle_counter();
		i32 res = wots_verify(&pk, &sig, msg);
		verify_sum += cycle_counter() - start;
		ASSERT(!res, "verify");
		msg[0]++;
		ASSERT(wots_verify(&pk, &sig, msg), "!verify");
	}

	pwrite(2, "keygen=", 7, 0);
	write_num(2, keygen_sum / WOTS_COUNT);
	pwrite(2, ",sign=", 6, 0);
	write_num(2, sign_sum / WOTS_COUNT);
	pwrite(2, ",verify=", 8, 0);
	write_num(2, verify_sum / WOTS_COUNT);
	pwrite(2, "\n", 1, 0);
}

#define BIBLE_PATH "resources/test_bible.dat"

Test(bible) {
	const Bible* b;
	u64 sbox[256];
	__attribute__((aligned(32))) static const u8 input[128] = {
	    1,	2,  3,	4,  5,	6,  7,	8,  9,	10, 11, 12, 13, 14, 15, 16,
	    17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32};
	__attribute__((aligned(32))) u8 output[32];

	if (!exists(BIBLE_PATH)) {
		if (IS_VALGRIND()) return;
		b = bible_gen(true);
		bible_store(b, BIBLE_PATH);
	} else
		b = bible_load(BIBLE_PATH);

	bible_sbox8_64(sbox);
	bible_hash(b, input, output, sbox);

	u8 expected[32] = {161, 219, 95,  165, 143, 81,	 8,  96,  175, 215, 101,
			   246, 130, 254, 99,  17,  61,	 84, 7,	  110, 157, 128,
			   179, 165, 67,  64,  193, 247, 70, 100, 54,  146};

	ASSERT(!memcmp(output, expected, 32), "hash");
	bible_destroy(b);
	b = bible_load(BIBLE_PATH);
	bible_destroy(b);
}

Test(bible_mine) {
	const Bible* b;
	u32 nonce = 0;
	u64 sbox[256];
	__attribute__((aligned(32))) u8 output[32] = {0};
	u8 target[32];
	__attribute((aligned(32))) u8 header[HASH_INPUT_LEN];

	for (u32 i = 0; i < HASH_INPUT_LEN; i++) header[i] = i;

	if (!exists(BIBLE_PATH)) {
		if (IS_VALGRIND()) return;
		b = bible_gen(false);
		bible_store(b, BIBLE_PATH);
	} else
		b = bible_load(BIBLE_PATH);

	memset(target, 0xFF, 32);
	target[0] = 0;
	target[1] = 0;
	bible_sbox8_64(sbox);
	mine_block(b, header, target, output, &nonce, U32_MAX, sbox);

	ASSERT_EQ(nonce, 1312, "nonce");
	ASSERT(!memcmp(output, (u8[]){0,   0,	28,  44,  170, 182, 139, 188,
				      55,  146, 148, 53,  14,  68,  79,	 182,
				      130, 246, 76,  17,  102, 240, 129, 186,
				      69,  227, 176, 231, 224, 33,  141, 0},
		       32),
	       "hash");
	bible_destroy(b);
}

Test(kem) {
	KemSecKey sk;
	KemPubKey pk;
	KemCipherText ct;
	KemSharedSecret ss_bob = {0}, ss_alice = {0};

	Rng rng1, rng2;
	rng_init(&rng1);
	rng_init(&rng2);
	keypair(&pk, &sk, &rng1);
	enc(&ct, &ss_bob, &pk, &rng2);
	dec(&ss_alice, &ct, &sk);
	ASSERT(!fastmemcmp(&ss_bob, &ss_alice, KEM_SS_SIZE), "shared secret");
}

#include <libfam/format.h>

Test(kem_vector) {
	__attribute__((aligned(32))) u8 seed[32] = {1, 2, 3};
	KemSecKey sk;
	KemPubKey pk;
	KemCipherText ct;
	KemSharedSecret ss_bob = {0}, ss_alice = {0};

	Rng rng;
	rng_init(&rng);
	rng_test_seed(&rng, seed);
	keypair(&pk, &sk, &rng);
	// print("pk: ");
	// for (u32 i = 0; i < sizeof(pk); i++) print("{}, ", pk.data[i]);
	u8 expected_sk[] = {
	    87,	 231, 142, 125, 144, 205, 154, 184, 147, 37,  134, 165, 23,
	    178, 165, 12,  10,	73,  121, 185, 0,   89,	 160, 165, 184, 252,
	    41,	 17,  50,  156, 75,  156, 141, 198, 209, 199, 176, 4,	11,
	    60,	 73,  180, 74,	66,  46,  228, 97,  90,	 29,  169, 158, 223,
	    74,	 110, 223, 108, 167, 55,  69,  139, 188, 236, 182, 180, 138,
	    49,	 109, 113, 96,	83,  181, 25,  35,  195, 162, 108, 73,	104,
	    72,	 121, 203, 219, 162, 66,  38,  236, 118, 132, 128, 149, 161,
	    224, 160, 173, 231, 43,  15,  39,  197, 98,	 180, 121, 164, 146,
	    88,	 58,  153, 35,	201, 101, 156, 145, 41,	 0,   199, 220, 12,
	    247, 85,  114, 241, 209, 114, 16,  219, 58,	 228, 138, 184, 95,
	    171, 8,   119, 193, 38,  23,  71,  19,  60,	 216, 125, 138, 6,
	    155, 75,  123, 81,	255, 120, 103, 26,  196, 83,  44,  130, 83,
	    180, 243, 94,  145, 6,   32,  136, 92,  157, 29,  163, 162, 186,
	    152, 41,  166, 9,	38,  55,  216, 109, 31,	 198, 182, 140, 97,
	    114, 33,  147, 106, 54,  163, 153, 136, 251, 105, 105, 152, 156,
	    165, 135, 190, 25,	67,  40,  254, 131, 10,	 242, 48,  48,	123,
	    60,	 183, 180, 167, 168, 198, 195, 60,  12,	 180, 94,  141, 149,
	    44,	 96,  40,  53,	225, 250, 162, 23,  25,	 105, 225, 4,	102,
	    80,	 58,  91,  215, 226, 19,  235, 44,  86,	 102, 216, 105, 99,
	    35,	 14,  67,  152, 36,  82,  181, 74,  25,	 224, 194, 163, 226,
	    118, 204, 153, 61,	109, 12,  138, 34,  187, 94,  86,  168, 144,
	    245, 33,  174, 52,	82,  144, 196, 144, 103, 223, 8,   129, 0,
	    24,	 74,  56,  137, 98,  112, 198, 111, 218, 178, 146, 200, 144,
	    155, 201, 88,  70,	35,  106, 27,  186, 226, 114, 3,   91,	40,
	    131, 247, 17,  12,	242, 174, 248, 115, 199, 38,  119, 68,	108,
	    28,	 111, 95,  167, 29,  29,  0,   208, 54,	 38,  63,  225, 252,
	    118, 206, 182, 101, 215, 51,  69,  74,  226, 145, 67,  147, 55,
	    37,	 91,  74,  60,	88,  24,  92,  228, 19,	 87,  243, 9,	77,
	    44,	 65,  165, 107, 207, 48,  7,   90,  229, 35,  100, 94,	180,
	    32,	 60,  184, 144, 50,  104, 9,   172, 89,	 111, 233, 248, 27,
	    22,	 188, 97,  40,	51,  128, 80,  240, 122, 204, 65,  26,	192,
	    28,	 184, 202, 43,	44,  250, 115, 2,   235, 213, 159, 126, 202,
	    182, 162, 16,  84,	227, 83,  185, 233, 59,	 59,  124, 152, 204,
	    216, 105, 190, 27,	243, 20,  134, 164, 72,	 23,  147, 64,	111,
	    24,	 178, 231, 213, 30,  48,  149, 41,  13,	 107, 14,  143, 162,
	    72,	 37,  112, 81,	68,  137, 87,  135, 161, 137, 89,  72,	23,
	    43,	 201, 182, 251, 249, 34,  94,  51,  119, 186, 177, 67,	141,
	    85,	 149, 57,  103, 36,  216, 19,  18,  179, 23,  29,  12,	90,
	    168, 88,  108, 195, 143, 171, 59,  231, 140, 110, 46,  85,	65,
	    18,	 236, 61,  206, 20,  10,  61,  8,   55,	 212, 24,  110, 195,
	    106, 125, 232, 24,	59,  11,  220, 155, 94,	 153, 18,  156, 42,
	    44,	 130, 40,  177, 64,  178, 48,  157, 54,	 150, 0,   131, 125,
	    141, 229, 197, 18,	18,  29,  144, 24,  29,	 202, 192, 149, 102,
	    194, 70,  39,  181, 181, 168, 4,   162, 215, 194, 109, 167, 124,
	    7,	 252, 33,  82,	190, 43,  126, 252, 184, 14,  140, 171, 86,
	    151, 168, 175, 44,	241, 32,  103, 0,   40,	 10,  50,  76,	182,
	    5,	 7,   9,   124, 175, 202, 85,  120, 95,	 168, 118, 173, 118,
	    120, 215, 72,  82,	205, 240, 178, 115, 50,	 188, 51,  74,	6,
	    208, 235, 9,   217, 70,  191, 233, 135, 22,	 176, 132, 89,	204,
	    72,	 158, 84,  196, 137, 173, 0,   162, 76,	 101, 194, 161, 149,
	    180, 106, 181, 105, 17,  108, 153, 206, 69,	 141, 187, 66,	126,
	    53,	 177, 185, 110, 227, 101, 228, 199, 193, 181, 37,  33,	31,
	    177, 107, 111, 182, 41,  62,  192, 86,  81,	 59,  25,  56,	39,
	    156, 171, 195, 70,	39,  11,  95,  172, 24,	 120, 214, 236, 27,
	    34,	 243, 27,  33,	245, 1,	  173, 55,  7,	 246, 197, 161, 78,
	    232, 168, 247, 150, 71,  196, 82,  119, 238, 167, 98,  211, 36,
	    43,	 59,  145, 197, 110, 44,  54,  193, 25,	 134, 85,  240, 184,
	    92,	 39,  122, 39,	220, 35,  188, 139, 156, 204, 48,  118, 212,
	    100, 137, 90,  242, 120, 193, 36,  91,  29,	 25,  49,  252, 17,
	    88,	 226, 22,  161, 179, 230, 155, 80,  176, 165, 167, 66,	165,
	    225, 37,  177, 131, 244, 167, 118, 133, 169, 145, 37,  168, 49,
	    135, 136, 88,  27,	142, 147, 107, 181, 191, 251, 77,  15,	82,
	    122, 110, 230, 112, 113, 132, 82,  8,   224, 61,  111, 100, 14,
	    30,	 183, 58,  249, 233, 105, 43,  89,  86,	 152, 240, 106, 60,
	    9,	 99,  229, 88,	69,  141, 185, 91,  31,	 130, 124, 32,	21,
	    2,	 52,  168, 172, 69,  169, 27,  220, 165, 7,   174, 57,	63,
	    225, 98,  36,  115, 70,  25,  127, 122, 206, 232, 89,  109, 180,
	    162, 195, 111, 42,	18,  53,  120, 33,  146, 215, 200, 182, 55,
	    168, 242, 104, 139, 169, 150, 14,  215, 91,	 15,  107, 199, 176,
	    223, 245, 170, 149, 129, 186, 249, 188, 0,	 119, 132, 58,	57,
	    10,	 144, 110, 140, 165, 136, 33,  53,  52,	 59,  178, 132, 70,
	    153, 150, 193, 187, 129, 224, 200, 240, 162, 39,  32,  169, 34,
	    173, 137, 90,  209, 180, 190, 15,  153, 91,	 70,  80,  176, 50,
	    135, 160, 2,   219, 41,  10,  17,  170, 225, 148, 166, 245, 229,
	    30,	 41,  5,   35,	132, 196, 176, 117, 163, 10,  208, 72,	25,
	    227, 178, 96,  72,	50,  139, 197, 117, 142, 72,  91,  206, 228,
	    178, 173, 164, 177, 67,  52,  224, 124, 87,	 162, 126, 2,	181,
	    78,	 96,  53,  161, 122, 53,  120, 174, 9,	 94,  13,  68,	124,
	    150, 39,  116, 168, 65,  45,  255, 38,  24,	 29,  212, 34,	94,
	    98,	 155, 113, 224, 197, 158, 56,  195, 240, 74,  184, 42,	247,
	    180, 33,  1,   4,	217, 90,  120, 90,  49,	 15,  75,  0,	120,
	    8,	 38,  163, 114, 106, 59,  76,  44,  105, 252, 241, 86,	173,
	    5,	 189, 170, 72,	8,   255, 11,  15,  252, 10,  73,  229, 131,
	    162, 148, 59,  155, 160, 154, 140, 137, 105, 170, 38,  177, 198,
	    11,	 131, 102, 43,	0,   114, 238, 152, 91,	 251, 55,  106, 187,
	    57,	 162, 220, 26,	177, 5,	  252, 83,  146, 19,  158, 190, 137,
	    136, 139, 64,  113, 26,  58,  78,  198, 146, 46,  26,  116, 101,
	    26,	 145, 194, 207, 172, 159, 162, 86,  181, 198, 102, 183, 167,
	    71,	 157, 184, 203, 16,  62,  187, 33,  203, 50,  136, 172, 209,
	    21,	 84,  160, 184, 203, 250, 124, 121, 84,	 42,  41,  148, 146,
	    16,	 224, 122, 51,	164, 15,  92,  136, 158, 130, 121, 22,	85,
	    69,	 78,  136, 131, 95,  177, 113, 98,  85,	 201, 207, 28,	180,
	    116, 131, 168, 91,	223, 71,  207, 187, 144, 147, 2,   137, 141,
	    83,	 124, 198, 239, 156, 187, 83,  132, 151, 177, 131, 134, 172,
	    188, 127, 86,  0,	28,  226, 91,  4,   47,	 187, 175, 105, 113,
	    128, 110, 150, 73,	121, 229, 103, 198, 28,	 142, 119, 8,	162,
	    39,	 193, 51,  190, 92,  15,  92,  33,  154, 20,  41,  191, 192,
	    252, 75,  105, 225, 48,  90,  1,   19,  130, 42,  116, 148, 213,
	    128, 98,  64,  189, 223, 54,  204, 159, 16,	 104, 156, 154, 116,
	    3,	 212, 33,  167, 186, 68,  173, 67,  195, 246, 195, 185, 220,
	    22,	 59,  164, 195, 165, 151, 2,   150, 204, 213, 44,  243, 49,
	    165, 178, 108, 152, 149, 84,  8,   192, 232, 58,  111, 24,	104,
	    209, 86,  33,  227, 167, 206, 49,  40,  88,	 173, 19,  16,	160,
	    69,	 145, 56,  129, 108, 9,	  0,   134, 129, 194, 91,  194, 160,
	    36,	 239, 149, 51,	53,  193, 140, 118, 183, 151, 216, 3,	116,
	    189, 209, 49,  248, 1,   11,  206, 217, 59,	 46,  135, 141, 119,
	    196, 179, 27,  48,	58,  45,  2,   170, 201, 179, 45,  191, 198,
	    64,	 37,  80,  102, 145, 162, 200, 245, 37,	 99,  241, 65,	47,
	    78,	 246, 122, 105, 164, 176, 185, 35,  32,	 255, 250, 168, 18,
	    87,	 165, 161, 247, 176, 126, 71,  36,  120, 244, 1,   155, 123,
	    161, 82,  210, 30,	120, 89,  2,   62,  98,	 38,  23,  41,	200,
	    118, 91,  2,   180, 34,  205, 249, 136, 176, 25,  231, 179, 155,
	    229, 113, 209, 147, 57,  103, 108, 101, 173, 12,  115, 43,	34,
	    183, 144, 90,  203, 186, 187, 32,  75,  167, 110, 190, 59,	161,
	    241, 182, 193, 241, 209, 174, 166, 20,  88,	 131, 72,  143, 253,
	    39,	 53,  221, 74,	189, 173, 163, 166, 164, 64,  52,  14,	24,
	    46,	 181, 177, 148, 221, 176, 139, 250, 44,	 87,  198, 208, 154,
	    49,	 92,  138, 105, 16,  175, 8,   11,  27,	 42,  103, 130, 169,
	    89,	 154, 90,  27,	190, 229, 131, 57,  8,	 164, 114, 166, 181,
	    226, 180, 74,  209, 108, 30,  112, 135, 252, 35,  241, 216, 232,
	    249, 253, 75,  178, 114, 82,  241, 38,  108, 47,  87,  237, 149,
	    133, 38,  44,  253, 171, 97,  131, 89,  123, 199, 110, 226, 215,
	    87,	 6,   96,  47,	164, 235, 82,  4,   116, 167, 255, 94,	68,
	    200, 175, 242, 27,	187, 98,  87,  212, 220, 169, 50,  128, 55,
	    38,	 100, 170, 60,	13,  170, 233, 101, 210, 192, 153, 214, 142,
	    115, 99,  39,  49,	106, 123, 15};
	u8 expected_pk[] = {
	    226, 22,  161, 179, 230, 155, 80,  176, 165, 167, 66,  165, 225,
	    37,	 177, 131, 244, 167, 118, 133, 169, 145, 37,  168, 49,	135,
	    136, 88,  27,  142, 147, 107, 181, 191, 251, 77,  15,  82,	122,
	    110, 230, 112, 113, 132, 82,  8,   224, 61,	 111, 100, 14,	30,
	    183, 58,  249, 233, 105, 43,  89,  86,  152, 240, 106, 60,	9,
	    99,	 229, 88,  69,	141, 185, 91,  31,  130, 124, 32,  21,	2,
	    52,	 168, 172, 69,	169, 27,  220, 165, 7,	 174, 57,  63,	225,
	    98,	 36,  115, 70,	25,  127, 122, 206, 232, 89,  109, 180, 162,
	    195, 111, 42,  18,	53,  120, 33,  146, 215, 200, 182, 55,	168,
	    242, 104, 139, 169, 150, 14,  215, 91,  15,	 107, 199, 176, 223,
	    245, 170, 149, 129, 186, 249, 188, 0,   119, 132, 58,  57,	10,
	    144, 110, 140, 165, 136, 33,  53,  52,  59,	 178, 132, 70,	153,
	    150, 193, 187, 129, 224, 200, 240, 162, 39,	 32,  169, 34,	173,
	    137, 90,  209, 180, 190, 15,  153, 91,  70,	 80,  176, 50,	135,
	    160, 2,   219, 41,	10,  17,  170, 225, 148, 166, 245, 229, 30,
	    41,	 5,   35,  132, 196, 176, 117, 163, 10,	 208, 72,  25,	227,
	    178, 96,  72,  50,	139, 197, 117, 142, 72,	 91,  206, 228, 178,
	    173, 164, 177, 67,	52,  224, 124, 87,  162, 126, 2,   181, 78,
	    96,	 53,  161, 122, 53,  120, 174, 9,   94,	 13,  68,  124, 150,
	    39,	 116, 168, 65,	45,  255, 38,  24,  29,	 212, 34,  94,	98,
	    155, 113, 224, 197, 158, 56,  195, 240, 74,	 184, 42,  247, 180,
	    33,	 1,   4,   217, 90,  120, 90,  49,  15,	 75,  0,   120, 8,
	    38,	 163, 114, 106, 59,  76,  44,  105, 252, 241, 86,  173, 5,
	    189, 170, 72,  8,	255, 11,  15,  252, 10,	 73,  229, 131, 162,
	    148, 59,  155, 160, 154, 140, 137, 105, 170, 38,  177, 198, 11,
	    131, 102, 43,  0,	114, 238, 152, 91,  251, 55,  106, 187, 57,
	    162, 220, 26,  177, 5,   252, 83,  146, 19,	 158, 190, 137, 136,
	    139, 64,  113, 26,	58,  78,  198, 146, 46,	 26,  116, 101, 26,
	    145, 194, 207, 172, 159, 162, 86,  181, 198, 102, 183, 167, 71,
	    157, 184, 203, 16,	62,  187, 33,  203, 50,	 136, 172, 209, 21,
	    84,	 160, 184, 203, 250, 124, 121, 84,  42,	 41,  148, 146, 16,
	    224, 122, 51,  164, 15,  92,  136, 158, 130, 121, 22,  85,	69,
	    78,	 136, 131, 95,	177, 113, 98,  85,  201, 207, 28,  180, 116,
	    131, 168, 91,  223, 71,  207, 187, 144, 147, 2,   137, 141, 83,
	    124, 198, 239, 156, 187, 83,  132, 151, 177, 131, 134, 172, 188,
	    127, 86,  0,   28,	226, 91,  4,   47,  187, 175, 105, 113, 128,
	    110, 150, 73,  121, 229, 103, 198, 28,  142, 119, 8,   162, 39,
	    193, 51,  190, 92,	15,  92,  33,  154, 20,	 41,  191, 192, 252,
	    75,	 105, 225, 48,	90,  1,	  19,  130, 42,	 116, 148, 213, 128,
	    98,	 64,  189, 223, 54,  204, 159, 16,  104, 156, 154, 116, 3,
	    212, 33,  167, 186, 68,  173, 67,  195, 246, 195, 185, 220, 22,
	    59,	 164, 195, 165, 151, 2,	  150, 204, 213, 44,  243, 49,	165,
	    178, 108, 152, 149, 84,  8,	  192, 232, 58,	 111, 24,  104, 209,
	    86,	 33,  227, 167, 206, 49,  40,  88,  173, 19,  16,  160, 69,
	    145, 56,  129, 108, 9,   0,	  134, 129, 194, 91,  194, 160, 36,
	    239, 149, 51,  53,	193, 140, 118, 183, 151, 216, 3,   116, 189,
	    209, 49,  248, 1,	11,  206, 217, 59,  46,	 135, 141, 119, 196,
	    179, 27,  48,  58,	45,  2,	  170, 201, 179, 45,  191, 198, 64,
	    37,	 80,  102, 145, 162, 200, 245, 37,  99,	 241, 65,  47,	78,
	    246, 122, 105, 164, 176, 185, 35,  32,  255, 250, 168, 18,	87,
	    165, 161, 247, 176, 126, 71,  36,  120, 244, 1,   155, 123, 161,
	    82,	 210, 30,  120, 89,  2,	  62,  98,  38,	 23,  41,  200, 118,
	    91,	 2,   180, 34,	205, 249, 136, 176, 25,	 231, 179, 155, 229,
	    113, 209, 147, 57,	103, 108, 101, 173, 12,	 115, 43,  34,	183,
	    144, 90,  203, 186, 187, 32,  75,  167, 110, 190, 59,  161, 241,
	    182, 193, 241, 209, 174, 166, 20,  88,  131, 72,  143, 253, 39,
	    53,	 221, 74,  189, 173, 163, 166, 164, 64,	 52,  14,  24,	46,
	    181, 177, 148, 221, 176, 139, 250, 44,  87,	 198, 208, 154, 49,
	    92,	 138, 105, 16,	175, 8,	  11,  27,  42,	 103, 130, 169, 89,
	    154, 90,  27,  190, 229, 131, 57,  8,   164, 114, 166, 181, 226,
	    180, 74,  209, 108, 30,  112, 135, 252, 35,	 241, 216, 232, 249,
	    253, 75,  178, 114, 82,  241, 38};
	ASSERT(!fastmemcmp(pk.data, expected_pk, sizeof(pk)), "pk");
	ASSERT(!fastmemcmp(sk.data, expected_sk, sizeof(sk)), "sk");
	enc(&ct, &ss_bob, &pk, &rng);
	u8 expected_ct[] = {
	    99,	 69,  201, 92,	234, 55,  131, 114, 56,	 58,  195, 242, 30,
	    27,	 41,  196, 107, 217, 107, 39,  206, 121, 25,  60,  95,	27,
	    46,	 102, 149, 124, 194, 161, 134, 224, 191, 97,  8,   69,	222,
	    45,	 146, 205, 58,	136, 10,  7,   173, 229, 250, 238, 220, 235,
	    59,	 249, 25,  109, 128, 6,	  23,  242, 23,	 218, 163, 212, 44,
	    118, 92,  250, 168, 151, 19,  72,  163, 136, 167, 73,  145, 38,
	    136, 114, 113, 50,	242, 192, 41,  237, 87,	 65,  125, 164, 254,
	    210, 141, 86,  63,	149, 97,  92,  239, 54,	 248, 247, 85,	223,
	    149, 91,  80,  214, 211, 246, 222, 79,  250, 223, 23,  161, 169,
	    103, 85,  172, 188, 255, 144, 155, 181, 124, 6,   128, 126, 57,
	    51,	 124, 63,  171, 87,  222, 147, 1,   35,	 141, 161, 75,	201,
	    15,	 236, 146, 82,	160, 173, 212, 254, 59,	 6,   157, 155, 186,
	    190, 28,  18,  23,	57,  255, 77,  68,  112, 142, 144, 120, 196,
	    102, 120, 211, 230, 188, 185, 199, 106, 133, 162, 115, 255, 170,
	    202, 5,   36,  33,	113, 151, 22,  167, 250, 82,  103, 120, 144,
	    137, 154, 38,  176, 27,  194, 101, 147, 203, 130, 176, 109, 29,
	    198, 194, 141, 132, 46,  244, 72,  101, 219, 217, 191, 40,	219,
	    189, 187, 51,  52,	53,  179, 253, 94,  92,	 140, 62,  255, 191,
	    246, 239, 50,  133, 93,  158, 38,  231, 146, 159, 136, 255, 76,
	    47,	 249, 247, 17,	101, 37,  110, 40,  149, 65,  1,   75,	177,
	    23,	 151, 209, 242, 91,  216, 19,  21,  117, 54,  64,  186, 23,
	    42,	 34,  112, 165, 240, 40,  192, 194, 171, 232, 118, 37,	35,
	    64,	 99,  28,  105, 164, 169, 37,  65,  116, 63,  191, 109, 43,
	    246, 192, 232, 130, 30,  98,  155, 177, 221, 208, 104, 62,	243,
	    122, 40,  202, 214, 96,  219, 247, 44,  44,	 69,  165, 54,	98,
	    236, 114, 219, 5,	113, 195, 10,  40,  63,	 37,  81,  99,	17,
	    84,	 230, 95,  77,	141, 149, 59,  50,  4,	 192, 51,  44,	61,
	    50,	 159, 22,  186, 88,  142, 245, 124, 67,	 162, 153, 52,	173,
	    23,	 17,  0,   74,	51,  129, 205, 104, 118, 71,  144, 250, 54,
	    248, 185, 235, 228, 169, 69,  69,  78,  54,	 56,  2,   131, 199,
	    87,	 173, 204, 208, 96,  197, 208, 150, 214, 248, 238, 103, 78,
	    184, 14,  13,  25,	217, 162, 255, 142, 183, 253, 33,  40,	250,
	    218, 163, 133, 13,	224, 49,  207, 70,  2,	 5,   1,   167, 8,
	    135, 17,  238, 41,	237, 122, 60,  196, 30,	 244, 25,  21,	189,
	    174, 20,  160, 232, 156, 162, 186, 243, 107, 241, 9,   190, 61,
	    176, 229, 180, 10,	169, 104, 26,  117, 158, 140, 189, 125, 102,
	    146, 236, 78,  237, 92,  229, 77,  35,  134, 7,   17,  188, 94,
	    33,	 70,  176, 150, 154, 95,  223, 82,  194, 195, 225, 148, 9,
	    66,	 133, 86,  84,	6,   228, 19,  89,  101, 104, 128, 120, 101,
	    158, 249, 143, 65,	97,  57,  48,  239, 218, 43,  57,  149, 172,
	    71,	 100, 100, 236, 48,  114, 218, 204, 71,	 107, 115, 38,	236,
	    69,	 134, 87,  85,	18,  154, 225, 183, 50,	 16,  23,  216, 72,
	    95,	 240, 134, 71,	210, 99,  214, 184, 21,	 42,  212, 130, 112,
	    169, 5,   223, 95,	239, 242, 60,  91,  54,	 100, 95,  66,	141,
	    87,	 222, 124, 242, 35,  230, 121, 66,  94,	 61,  101, 178, 168,
	    154, 244, 143, 243, 97,  78,  178, 165, 41,	 24,  156, 221, 115,
	    143, 73,  227, 84,	87,  145, 214, 64,  216, 19,  182, 8,	11,
	    195, 36,  145, 146, 46,  183, 100, 136, 35,	 104, 115, 0,	115,
	    62,	 58,  205, 15,	39,  92,  106, 5,   71,	 196, 82,  252, 234,
	    233, 11,  222, 127, 211, 117, 171, 228, 169, 229, 151, 220, 102,
	    144, 85,  129, 248, 196, 254, 7,   35,  52,	 56,  151, 239, 104,
	    135, 242, 77,  229, 210, 211, 179, 249, 100, 21,  146, 26,	132,
	    63,	 110, 171, 165, 131, 58,  42,  90,  176, 96,  151, 171, 233,
	    111, 228, 237, 243, 44,  76,  10,  29,  43,	 170, 122, 88,	187,
	    123, 213, 203, 45,	24,  170, 234, 1,   192, 117, 158, 90,	171,
	    249, 108, 245, 208, 131, 191, 156, 92,  155, 30,  185, 164, 232,
	    186, 11,  170, 159, 57,  252, 33,  146, 111, 5,   245, 170, 54,
	    130, 153, 185, 82,	14,  228, 73,  28,  22,	 18,  47,  42,	244,
	    232, 120, 203, 51,	82,  56,  29,  237, 138, 184, 210, 73,	113,
	    103};
	// print("ct: ");
	// for (u32 i = 0; i < sizeof(ct); i++) print("{}, ", ct.data[i]);
	(void)expected_ct;
	(void)expected_pk;
	(void)expected_sk;
	ASSERT(!memcmp(&ct, expected_ct, sizeof(ct)), "ct");
	dec(&ss_alice, &ct, &sk);
	// for (u32 i = 0; i < sizeof(ss_bob); i++) print("{}, ",
	// ss_bob.data[i]);

	ASSERT(!fastmemcmp(&ss_bob, &ss_alice, KEM_SS_SIZE), "shared secret");
	u8 expected[32] = {200, 34, 146, 216, 220, 168, 180, 182, 17,  111, 159,
			   15,	1,  90,	 246, 51,  73,	147, 146, 206, 198, 36,
			   17,	8,  131, 101, 142, 73,	65,  67,  167, 94};

	ASSERT(!fastmemcmp(&ss_bob, expected, KEM_SS_SIZE), "expected");
}

Test(kem_iter) {
	KemSecKey sk;
	KemPubKey pk;
	KemCipherText ct;
	KemSharedSecret ss_bob = {0}, ss_alice = {0};
	Rng rng1, rng2;

	for (u32 i = 0; i < 1000; i++) {
		rng_init(&rng1);
		rng_init(&rng2);

		keypair(&pk, &sk, &rng1);
		enc(&ct, &ss_bob, &pk, &rng2);
		dec(&ss_alice, &ct, &sk);
		ASSERT(!fastmemcmp(&ss_bob, &ss_alice, KEM_SS_SIZE),
		       "shared secret");
	}
}

#define KEM_COUNT 10000

Bench(kempf) {
	KemSecKey sk;
	KemPubKey pk;
	KemCipherText ct;
	KemSharedSecret ss_bob = {0}, ss_alice = {0};
	Rng rng1, rng2;
	u64 keygen_sum = 0;
	u64 enc_sum = 0;
	u64 dec_sum = 0;

	for (u32 i = 0; i < KEM_COUNT; i++) {
		rng_init(&rng1);
		rng_init(&rng2);

		u64 start = cycle_counter();
		keypair(&pk, &sk, &rng1);
		keygen_sum += cycle_counter() - start;
		start = cycle_counter();
		enc(&ct, &ss_bob, &pk, &rng2);
		enc_sum += cycle_counter() - start;
		start = cycle_counter();
		dec(&ss_alice, &ct, &sk);
		dec_sum += cycle_counter() - start;
		ASSERT(!fastmemcmp(&ss_bob, &ss_alice, KEM_SS_SIZE),
		       "shared secret");
	}

	pwrite(2, "keygen=", 7, 0);
	write_num(2, keygen_sum / KEM_COUNT);
	pwrite(2, ",enc=", 5, 0);
	write_num(2, enc_sum / KEM_COUNT);
	pwrite(2, ",dec=", 5, 0);
	write_num(2, dec_sum / KEM_COUNT);
	pwrite(2, "\n", 1, 0);
}

