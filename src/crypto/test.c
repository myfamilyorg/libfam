/********************************************************************************
 * MIT License
 *
 * Copyright (c) 2025 Christopher Gilliard
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 *
 *******************************************************************************/

#include <libfam/aighthash.h>
#include <libfam/bible.h>
#include <libfam/env.h>
#include <libfam/kem.h>
#include <libfam/limits.h>
#include <libfam/rng.h>
#include <libfam/storm.h>
#include <libfam/string.h>
#include <libfam/test_base.h>
#include <libfam/wots.h>

Test(storm_vectors) {
	StormContext ctx;
	__attribute__((aligned(32))) const u8 SEED[32] = {1, 2, 3};
	__attribute((aligned(32))) u8 buf1[32] = {
	    9,	 93,  216, 137, 224, 212, 105, 200, 163, 28,  146,
	    246, 75,  164, 149, 109, 209, 70,  183, 116, 224, 157,
	    245, 221, 5,   53,	245, 155, 165, 135, 142, 218};
	storm_init(&ctx, SEED);
	storm_next_block(&ctx, buf1);

	u8 exp1[32] = {0,   44, 64, 186, 106, 113, 172, 78,  14,  234, 67,
		       247, 7,	57, 25,	 97,  57,  105, 29,  115, 159, 138,
		       37,  57, 65, 176, 12,  144, 174, 186, 4,	  236};
	ASSERT(!memcmp(buf1, exp1, sizeof(buf1)), "buf1");
	storm_next_block(&ctx, buf1);

	u8 exp2[32] = {210, 174, 13,  100, 187, 212, 168, 128, 197, 235, 213,
		       78,  125, 115, 205, 92,	133, 242, 110, 234, 125, 133,
		       168, 230, 240, 252, 10,	168, 89,  227, 74,  62};

	ASSERT(!memcmp(buf1, exp2, sizeof(buf1)), "buf1 round2");

	__attribute((aligned(32))) u8 buf2[32] = {
	    32, 31, 30, 29, 28, 27, 26, 25, 24, 23, 22, 21, 20, 19, 18, 17,
	    16, 15, 14, 13, 12, 11, 10, 9,  8,	7,  6,	5,  4,	3,  2,	1};
	storm_init(&ctx, SEED);
	storm_next_block(&ctx, buf2);

	u8 exp3[32] = {76,  212, 26,  233, 216, 75,  41,  110, 6,   94,	 20,
		       169, 41,	 185, 138, 213, 219, 243, 79,  197, 109, 50,
		       141, 245, 8,   239, 144, 130, 167, 122, 21,  239};
	ASSERT(!memcmp(buf2, exp3, sizeof(buf2)), "buf2");

	storm_next_block(&ctx, buf2);

	u8 exp4[32] = {162, 251, 154, 18,  139, 107, 17,  243, 220, 138, 196,
		       181, 69,	 163, 85,  123, 226, 16,  149, 98,  13,	 154,
		       218, 24,	 241, 200, 137, 0,   247, 150, 246, 123};
	ASSERT(!memcmp(buf2, exp4, sizeof(buf2)), "buf2 round2");
}

Test(storm_cipher) {
	StormContext ctx;
	__attribute__((aligned(32))) const u8 SEED[32] = {1, 2, 3};
	__attribute__((aligned(32))) u8 buffer1[32] = {0};
	__attribute__((aligned(32))) u8 buffer2[32] = {0};
	__attribute__((aligned(32))) u8 buffer3[32] = {0};
	__attribute__((aligned(32))) u8 buffer4[32] = {0};
	__attribute__((aligned(32))) u8 buffer5[32] = {0};

	storm_init(&ctx, SEED);
	faststrcpy(buffer1, "test1");
	storm_xcrypt_buffer(&ctx, buffer1);
	faststrcpy(buffer2, "test2");
	storm_xcrypt_buffer(&ctx, buffer2);
	faststrcpy(buffer3, "blahblah");
	storm_xcrypt_buffer(&ctx, buffer3);
	faststrcpy(buffer4, "ok");
	storm_xcrypt_buffer(&ctx, buffer4);
	faststrcpy(buffer5, "x");
	storm_xcrypt_buffer(&ctx, buffer5);

	ASSERT(memcmp(buffer1, "test1", 5), "ne1");
	ASSERT(memcmp(buffer2, "test2", 5), "ne2");
	ASSERT(memcmp(buffer3, "blahblah", 8), "ne3");
	ASSERT(memcmp(buffer4, "ok", 2), "ne4");
	ASSERT(memcmp(buffer5, "x", 1), "ne5");

	StormContext ctx2;
	storm_init(&ctx2, SEED);

	storm_xcrypt_buffer(&ctx2, buffer1);
	ASSERT(!memcmp(buffer1, "test1", 5), "eq1");
	storm_xcrypt_buffer(&ctx2, buffer2);
	ASSERT(!memcmp(buffer2, "test2", 5), "eq2");

	storm_xcrypt_buffer(&ctx2, buffer3);
	ASSERT(!memcmp(buffer3, "blahblah", 8), "eq3");

	storm_xcrypt_buffer(&ctx2, buffer4);
	ASSERT(!memcmp(buffer4, "ok", 2), "eq4");

	storm_xcrypt_buffer(&ctx2, buffer5);
	ASSERT(!memcmp(buffer5, "x", 1), "eq5");
}

Test(storm_cipher_vector) {
	StormContext ctx;
	__attribute__((aligned(32))) const u8 SEED[32] = {1, 2, 3};
	__attribute__((aligned(32))) u8 buffer1[32] = {0};
	__attribute__((aligned(32))) u8 buffer2[32] = {0};

	storm_init(&ctx, SEED);
	faststrcpy(buffer1, "test1");
	storm_xcrypt_buffer(&ctx, buffer1);
	faststrcpy(buffer2, "test2");
	storm_xcrypt_buffer(&ctx, buffer2);

	u8 expected1[32] = {208, 219, 23,  2,	102, 98,  157, 53,
			    88,	 199, 188, 237, 126, 195, 16,  183,
			    63,	 14,  194, 187, 89,  153, 201, 245,
			    3,	 242, 121, 53,	200, 243, 205, 126};
	ASSERT(!memcmp(buffer1, expected1, 32), "expected1");
	u8 expected2[32] = {161, 153, 144, 19,	202, 43,  81,  154,
			    83,	 150, 76,  209, 103, 85,  1,   74,
			    116, 231, 230, 62,	23,  126, 208, 173,
			    13,	 252, 88,  139, 176, 20,  42,  167};
	ASSERT(!memcmp(buffer2, expected2, 32), "expected2");
}

#define STORM_COUNT (1000000000 / 32)
static __attribute__((aligned(32))) u8 ZERO_SEED[32] = {0};
static __attribute__((aligned(32))) u8 ONE_SEED[32] = {1};
static __attribute__((aligned(32))) u8 TWO_SEED[32] = {2};
static __attribute__((aligned(32))) u8 THREE_SEED[32] = {3};
static __attribute__((aligned(32))) u8 FOUR_SEED[32] = {4};
static __attribute__((aligned(32))) u8 FIVE_SEED[32] = {5};

Bench(storm) {
	i64 timer;
	__attribute__((aligned(32))) u8 buf1[64] = {0};
	__attribute__((aligned(32))) u8 buf2[64] = {0};
	__attribute__((aligned(32))) u8 buf3[64] = {0};
	__attribute__((aligned(32))) u8 buf4[64] = {0};
	__attribute__((aligned(32))) u8 buf5[64] = {0};
	__attribute__((aligned(32))) u8 buf6[64] = {0};

	StormContext ctx1;
	StormContext ctx2;
	StormContext ctx3;
	StormContext ctx4;
	StormContext ctx5;
	StormContext ctx6;

	storm_init(&ctx1, ZERO_SEED);
	storm_init(&ctx2, ONE_SEED);
	storm_init(&ctx3, TWO_SEED);
	storm_init(&ctx4, THREE_SEED);
	storm_init(&ctx5, FOUR_SEED);
	storm_init(&ctx6, FIVE_SEED);

	timer = micros();
	for (u32 i = 0; i < STORM_COUNT; i++) {
		u8* block1 = buf1 + (i & 32);
		u8* block2 = buf2 + (i & 32);
		u8* block3 = buf3 + (i & 32);
		u8* block4 = buf4 + (i & 32);
		u8* block5 = buf5 + (i & 32);
		u8* block6 = buf6 + (i & 32);

		storm_xcrypt_buffer(&ctx1, block1);
		storm_xcrypt_buffer(&ctx2, block2);
		storm_xcrypt_buffer(&ctx3, block3);
		storm_xcrypt_buffer(&ctx4, block4);
		storm_xcrypt_buffer(&ctx5, block5);
		storm_xcrypt_buffer(&ctx6, block6);
	}
	timer = micros() - timer;

	pwrite(2, "time=", 5, 0);
	write_num(2, timer);
	pwrite(2, ",avg=", 5, 0);
	write_num(2, (timer * 1000) / STORM_COUNT);
	pwrite(2, "ns\n", 3, 0);
}

Test(rng) {
	u64 x = 0, y = 0;
	__attribute__((aligned(32))) u8 z[64] = {0};
	Rng rng;
	__attribute__((aligned(32))) u8 key[32] = {5, 5, 5, 5};
	rng_init(&rng);
	rng_gen(&rng, &x, sizeof(x));
	rng_init(&rng);
	rng_gen(&rng, &y, sizeof(y));
	ASSERT(x != y, "x!=y");

	rng_test_seed(&rng, key);
	rng_gen(&rng, z, sizeof(z));

	u8 expected[64] = {
	    241, 172, 79,  71,	20,  35,  84,  2,   39,	 165, 18,  232, 21,
	    84,	 178, 57,  205, 39,  187, 146, 20,  199, 114, 41,  245, 137,
	    175, 6,   181, 187, 130, 62,  195, 118, 94,	 242, 150, 45,	156,
	    18,	 240, 207, 220, 197, 36,  154, 149, 82,	 140, 108, 33,	154,
	    30,	 22,  146, 169, 199, 72,  2,   124, 117, 60,  141, 191};
	ASSERT_EQ(memcmp(z, expected, 64), 0, "z");
}

#define RNG_BYTES (32 * 1000000ULL)

Bench(rngpf) {
	u8 fbuf[1024] = {0};
	__attribute__((aligned(32))) u8 buffer1[32] = {0};
	__attribute__((aligned(32))) u8 buffer2[32] = {0};
	__attribute__((aligned(32))) u8 buffer3[32] = {0};
	__attribute__((aligned(32))) u8 buffer4[32] = {0};
	__attribute__((aligned(32))) u8 buffer5[32] = {0};
	__attribute__((aligned(32))) u8 buffer6[32] = {0};

	i64 needed = RNG_BYTES;
	Rng rng1, rng2, rng3, rng4, rng5, rng6;
	u64 total_cycles = 0;

	rng_init(&rng1);
	rng_init(&rng2);
	rng_init(&rng3);
	rng_init(&rng4);
	rng_init(&rng5);
	rng_init(&rng6);

	while (needed > 0) {
		u64 start;
		start = cycle_counter();
		rng_gen(&rng1, buffer1, 32);
		rng_gen(&rng2, buffer2, 32);
		rng_gen(&rng3, buffer3, 32);
		rng_gen(&rng4, buffer4, 32);
		rng_gen(&rng5, buffer5, 32);
		rng_gen(&rng6, buffer6, 32);
		total_cycles += cycle_counter() - start;

		needed -= 32;
	}
	const u8 msg[] = "cycles_per_byte=";
	pwrite(2, msg, strlen(msg), 0);
	f64_to_string(fbuf,
		      (f64)(total_cycles * 100 / (6 * RNG_BYTES)) / (f64)100, 2,
		      false);
	pwrite(2, fbuf, strlen(fbuf), 0);
	pwrite(2, "\n", 1, 0);
}

Test(aighthash) {
	u32 v1, v2, v3;

	v1 = aighthash32("11111111abc", 11, 0);
	v2 = aighthash32("11111111abc\0", 12, 0);
	v3 = aighthash32("11111111abc", 11, 0);
	ASSERT(v1 != v2, "v1 != v2");
	ASSERT(v1 == v3, "v1 == v3");

	u64 h1, h2, h3;

	h1 = aighthash64("XXXXXXXXXXXXXXXXxyz", 19, 0);
	h2 = aighthash64("XXXXXXXXXXXXXXXXxyz\0", 20, 0);
	h3 = aighthash64("XXXXXXXXXXXXXXXXxyz", 19, 0);
	ASSERT(h1 != h2, "h1 != h2");
	ASSERT(h1 == h3, "h1 == h3");
}

Test(wots) {
	__attribute__((aligned(32))) u8 key[32] = {1, 2, 3, 4, 5};
	WotsPubKey pk;
	WotsSecKey sk;
	WotsSig sig;
	u8 msg[32] = {9, 9, 9, 9, 9, 4};

	wots_keyfrom(key, &pk, &sk);
	wots_sign(&sk, msg, &sig);
	ASSERT(!wots_verify(&pk, &sig, msg), "verify");
	msg[0]++;
	ASSERT(wots_verify(&pk, &sig, msg), "!verify");
}

#define WOTS_COUNT 1000

Bench(wotsp) {
	__attribute__((aligned(32))) u8 key[32] = {0};
	__attribute__((aligned(32))) u8 msg[32] = {0};
	WotsPubKey pk;
	WotsSecKey sk;
	WotsSig sig;

	Rng rng;
	u64 keygen_sum = 0;
	u64 sign_sum = 0;
	u64 verify_sum = 0;

	rng_init(&rng);

	for (u32 i = 0; i < WOTS_COUNT; i++) {
		rng_gen(&rng, key, 32);
		rng_gen(&rng, msg, 32);

		u64 start = cycle_counter();
		wots_keyfrom(key, &pk, &sk);
		keygen_sum += cycle_counter() - start;
		start = cycle_counter();
		wots_sign(&sk, msg, &sig);
		sign_sum += cycle_counter() - start;
		start = cycle_counter();
		i32 res = wots_verify(&pk, &sig, msg);
		verify_sum += cycle_counter() - start;
		ASSERT(!res, "verify");
		msg[0]++;
		ASSERT(wots_verify(&pk, &sig, msg), "!verify");
	}

	pwrite(2, "keygen=", 7, 0);
	write_num(2, keygen_sum / WOTS_COUNT);
	pwrite(2, ",sign=", 6, 0);
	write_num(2, sign_sum / WOTS_COUNT);
	pwrite(2, ",verify=", 8, 0);
	write_num(2, verify_sum / WOTS_COUNT);
	pwrite(2, "\n", 1, 0);
}

#define BIBLE_PATH "resources/test_bible.dat"

Test(bible) {
	const Bible* b;
	u64 sbox[256];
	__attribute__((aligned(32))) static const u8 input[128] = {
	    1,	2,  3,	4,  5,	6,  7,	8,  9,	10, 11, 12, 13, 14, 15, 16,
	    17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32};
	__attribute__((aligned(32))) u8 output[32];

	if (!exists(BIBLE_PATH)) {
		if (IS_VALGRIND()) return;
		b = bible_gen(true);
		bible_store(b, BIBLE_PATH);
	} else
		b = bible_load(BIBLE_PATH);

	bible_sbox8_64(sbox);
	bible_hash(b, input, output, sbox);

	u8 expected[32] = {161, 219, 95,  165, 143, 81,	 8,  96,  175, 215, 101,
			   246, 130, 254, 99,  17,  61,	 84, 7,	  110, 157, 128,
			   179, 165, 67,  64,  193, 247, 70, 100, 54,  146};

	ASSERT(!memcmp(output, expected, 32), "hash");
	bible_destroy(b);
	b = bible_load(BIBLE_PATH);
	bible_destroy(b);
}

Test(bible_mine) {
	const Bible* b;
	u32 nonce = 0;
	u64 sbox[256];
	__attribute__((aligned(32))) u8 output[32] = {0};
	u8 target[32];
	__attribute((aligned(32))) u8 header[HASH_INPUT_LEN];

	for (u32 i = 0; i < HASH_INPUT_LEN; i++) header[i] = i;

	if (!exists(BIBLE_PATH)) {
		if (IS_VALGRIND()) return;
		b = bible_gen(false);
		bible_store(b, BIBLE_PATH);
	} else
		b = bible_load(BIBLE_PATH);

	memset(target, 0xFF, 32);
	target[0] = 0;
	target[1] = 0;
	bible_sbox8_64(sbox);
	mine_block(b, header, target, output, &nonce, U32_MAX, sbox);

	ASSERT_EQ(nonce, 1312, "nonce");
	ASSERT(!memcmp(output, (u8[]){0,   0,	28,  44,  170, 182, 139, 188,
				      55,  146, 148, 53,  14,  68,  79,	 182,
				      130, 246, 76,  17,  102, 240, 129, 186,
				      69,  227, 176, 231, 224, 33,  141, 0},
		       32),
	       "hash");
	bible_destroy(b);
}

Test(kem) {
	KemSecKey sk;
	KemPubKey pk;
	KemCipherText ct;
	KemSharedSecret ss_bob = {0}, ss_alice = {0};

	Rng rng1, rng2;
	rng_init(&rng1);
	rng_init(&rng2);
	keypair(&pk, &sk, &rng1);
	enc(&ct, &ss_bob, &pk, &rng2);
	dec(&ss_alice, &ct, &sk);
	ASSERT(!fastmemcmp(&ss_bob, &ss_alice, KEM_SS_SIZE), "shared secret");
}

#include <libfam/format.h>

Test(kem_vector) {
	__attribute__((aligned(32))) u8 seed[32] = {1, 2, 3};
	KemSecKey sk;
	KemPubKey pk;
	KemCipherText ct;
	KemSharedSecret ss_bob = {0}, ss_alice = {0};

	Rng rng;
	rng_init(&rng);
	rng_test_seed(&rng, seed);
	keypair(&pk, &sk, &rng);
	u8 expected_sk[] = {
	    76,	 72,  25,  35,	185, 109, 252, 100, 9,	 57,  195, 174, 129,
	    75,	 75,  155, 177, 190, 164, 67,  123, 9,	 177, 61,  130, 140,
	    200, 216, 132, 82,	94,  1,	  50,  193, 10,	 155, 178, 17,	207,
	    82,	 58,  179, 138, 105, 113, 166, 116, 31,	 159, 200, 113, 179,
	    64,	 73,  5,   181, 128, 243, 211, 183, 170, 20,  0,   207, 182,
	    81,	 187, 144, 150, 17,  121, 157, 0,   21,	 112, 252, 213, 126,
	    101, 201, 27,  151, 226, 105, 153, 100, 42,	 20,  204, 200, 22,
	    69,	 97,  205, 104, 133, 67,  204, 180, 32,	 50,  5,   6,	44,
	    68,	 15,  107, 146, 199, 86,  152, 33,  198, 20,  4,   116, 194,
	    190, 208, 76,  190, 120, 63,  223, 32,  46,	 149, 91,  40,	133,
	    76,	 14,  17,  1,	39,  100, 98,  2,   125, 82,  74,  138, 128,
	    195, 122, 229, 63,	192, 167, 161, 9,   88,	 169, 49,  137, 196,
	    227, 90,  114, 107, 184, 119, 183, 1,   9,	 221, 196, 139, 161,
	    122, 205, 156, 112, 133, 91,  37,  146, 100, 210, 151, 34,	188,
	    112, 236, 244, 151, 34,  52,  34,  247, 226, 57,  235, 171, 45,
	    107, 1,   125, 128, 146, 86,  171, 10,  16,	 77,  156, 88,	10,
	    217, 188, 15,  105, 120, 169, 53,  42,  122, 56,  43,  188, 250,
	    83,	 252, 25,  196, 4,   6,	  77,  239, 184, 62,  36,  18,	184,
	    233, 32,  170, 168, 171, 143, 87,  148, 106, 228, 172, 140, 137,
	    21,	 149, 85,  193, 98,  195, 218, 33,  105, 92,  166, 114, 54,
	    88,	 164, 20,  199, 233, 192, 207, 80,  178, 3,   140, 163, 4,
	    126, 136, 87,  218, 34,  43,  82,  112, 206, 94,  224, 103, 140,
	    241, 145, 129, 114, 187, 40,  246, 66,  95,	 74,  91,  253, 16,
	    120, 164, 106, 61,	182, 112, 39,  199, 130, 1,   226, 17,	153,
	    33,	 235, 26,  130, 192, 200, 130, 98,  62,	 105, 20,  162, 172,
	    114, 55,  63,  35,	61,  145, 197, 144, 120, 133, 13,  145, 216,
	    130, 39,  92,  73,	118, 243, 151, 67,  218, 53,  62,  108, 73,
	    36,	 54,  194, 17,	204, 35,  9,   84,  111, 30,  119, 99,	185,
	    161, 196, 118, 55,	56,  56,  149, 103, 139, 209, 87,  237, 177,
	    130, 246, 55,  77,	180, 214, 12,  197, 181, 92,  67,  114, 117,
	    165, 244, 141, 255, 132, 5,	  72,  40,  98,	 222, 54,  66,	250,
	    170, 11,  103, 195, 165, 182, 211, 121, 48,	 101, 116, 172, 104,
	    110, 22,  146, 18,	102, 233, 160, 82,  41,	 168, 123, 193, 141,
	    164, 153, 199, 191, 73,  182, 85,  166, 107, 201, 59,  183, 3,
	    114, 1,   249, 210, 12,  99,  18,  81,  251, 168, 78,  6,	188,
	    174, 154, 165, 169, 197, 152, 35,  133, 241, 158, 8,   149, 115,
	    232, 58,  19,  48,	144, 95,  6,   145, 100, 43,  161, 202, 185,
	    220, 134, 133, 183, 186, 202, 56,  137, 136, 242, 156, 44,	11,
	    77,	 46,  140, 26,	197, 240, 75,  121, 18,	 140, 243, 150, 143,
	    246, 99,  0,   50,	114, 111, 250, 82,  21,	 177, 50,  13,	202,
	    229, 1,   225, 246, 115, 60,  247, 136, 185, 186, 142, 82,	51,
	    90,	 61,  231, 25,	66,  92,  26,  196, 71,	 11,  99,  156, 112,
	    67,	 140, 159, 23,	167, 58,  49,  86,  93,	 130, 201, 107, 39,
	    153, 24,  110, 233, 135, 190, 52,  67,  126, 231, 44,  123, 113,
	    157, 221, 26,  94,	31,  22,  65,  69,  240, 39,  253, 9,	29,
	    127, 151, 79,  15,	246, 55,  43,  66,  204, 59,  135, 198, 109,
	    232, 82,  83,  177, 12,  57,  246, 53,  111, 107, 97,  204, 113,
	    48,	 196, 235, 67,	28,  36,  13,  0,   40,	 29,  164, 57,	162,
	    244, 112, 41,  143, 80,  59,  74,  74,  173, 215, 211, 143, 40,
	    196, 45,  100, 67,	54,  198, 21,  113, 5,	 96,  7,   216, 231,
	    0,	 189, 176, 163, 65,  128, 38,  208, 70,	 47,  239, 114, 106,
	    187, 5,   124, 160, 22,  141, 246, 228, 73,	 17,  179, 46,	32,
	    40,	 75,  124, 242, 146, 62,  44,  180, 163, 16,  47,  164, 149,
	    179, 18,  139, 110, 159, 248, 110, 98,  210, 149, 59,  118, 176,
	    143, 148, 64,  253, 4,   104, 209, 219, 160, 143, 67,  197, 113,
	    129, 135, 78,  112, 198, 133, 11,  194, 129, 113, 30,  9,	55,
	    132, 16,  88,  201, 217, 242, 166, 84,  197, 5,   185, 211, 156,
	    195, 50,  132, 38,	168, 89,  75,  113, 196, 39,  64,  206, 98,
	    224, 120, 13,  39,	152, 33,  104, 96,  212, 0,   131, 252, 65,
	    142, 153, 69,  106, 82,  163, 117, 20,  48,	 26,  139, 231, 119,
	    237, 73,  191, 194, 52,  56,  183, 4,   148, 180, 76,  197, 231,
	    25,	 109, 107, 154, 68,  128, 66,  185, 12,	 140, 25,  20,	178,
	    106, 83,  146, 61,	105, 2,	  50,  82,  71,	 117, 135, 244, 85,
	    116, 196, 105, 165, 198, 138, 80,  236, 119, 43,  119, 18,	38,
	    201, 79,  135, 51,	189, 93,  90,  6,   200, 26,  198, 135, 226,
	    55,	 153, 220, 36,	120, 154, 98,  209, 2,	 85,  202, 52,	166,
	    63,	 86,  8,   150, 6,   192, 106, 134, 112, 209, 151, 153, 102,
	    92,	 62,  77,  140, 42,  215, 88,  167, 166, 4,   57,  144, 243,
	    158, 28,  4,   208, 65,  23,  161, 15,  133, 111, 10,  244, 64,
	    186, 224, 119, 49,	146, 126, 220, 215, 44,	 197, 66,  100, 132,
	    20,	 23,  207, 38,	198, 227, 81,  174, 198, 209, 65,  58,	28,
	    188, 155, 160, 38,	199, 200, 187, 214, 43,	 67,  63,  163, 85,
	    113, 70,  63,  172, 136, 57,  103, 21,  157, 152, 102, 66,	137,
	    69,	 165, 183, 144, 147, 56,  75,  161, 84,	 117, 107, 170, 136,
	    180, 94,  136, 23,	250, 170, 80,  139, 73,	 195, 161, 194, 21,
	    247, 71,  106, 45,	179, 167, 187, 252, 111, 167, 96,  148, 199,
	    22,	 130, 0,   5,	165, 82,  176, 158, 148, 55,  138, 245, 112,
	    107, 105, 226, 70,	196, 193, 127, 123, 233, 81,  23,  235, 15,
	    21,	 117, 162, 167, 48,  94,  132, 89,  109, 25,  54,  160, 72,
	    122, 147, 61,  240, 154, 13,  200, 143, 174, 149, 172, 159, 194,
	    137, 95,  102, 11,	81,  102, 83,  73,  133, 116, 195, 43,	13,
	    46,	 32,  159, 232, 186, 166, 228, 210, 169, 152, 234, 13,	182,
	    123, 91,  138, 80,	81,  234, 50,  68,  70,	 75,  56,  196, 112,
	    175, 212, 214, 56,	72,  66,  177, 238, 200, 14,  59,  90,	34,
	    191, 164, 150, 171, 83,  19,  55,  70,  170, 158, 154, 77,	179,
	    37,	 28,  65,  75,	162, 71,  134, 178, 108, 119, 58,  171, 171,
	    37,	 152, 234, 47,	169, 247, 53,  21,  194, 156, 220, 113, 54,
	    180, 60,  5,   187, 68,  48,  91,  67,  76,	 37,  250, 198, 32,
	    250, 104, 242, 73,	136, 62,  123, 93,  109, 149, 186, 60,	210,
	    127, 217, 80,  19,	99,  156, 156, 51,  11,	 62,  201, 211, 0,
	    174, 214, 105, 109, 139, 147, 207, 86,  206, 183, 204, 33,	252,
	    124, 119, 154, 218, 139, 26,  21,  78,  155, 106, 46,  228, 57,
	    31,	 184, 89,  80,	172, 163, 112, 207, 166, 130, 253, 10,	183,
	    96,	 151, 13,  121, 64,  153, 178, 57,  14,	 204, 168, 83,	240,
	    245, 50,  161, 0,	20,  173, 171, 130, 107, 4,   192, 49,	246,
	    11,	 69,  97,  109, 32,  75,  63,  142, 53,	 119, 185, 19,	105,
	    204, 28,  157, 103, 88,  98,  154, 199, 190, 51,  247, 132, 39,
	    64,	 164, 39,  70,	57,  98,  7,   158, 99,	 112, 108, 101, 64,
	    104, 44,  218, 120, 55,  241, 17,  198, 38,	 172, 214, 70,	88,
	    85,	 194, 116, 9,	224, 206, 123, 90,  169, 213, 50,  188, 98,
	    215, 192, 106, 19,	55,  204, 216, 121, 129, 72,  129, 200, 219,
	    158, 125, 234, 140, 23,  234, 166, 76,  85,	 35,  235, 226, 198,
	    25,	 252, 7,   17,	74,  163, 250, 171, 135, 130, 132, 64,	128,
	    26,	 2,   188, 101, 152, 95,  235, 10,  149, 144, 191, 219, 165,
	    174, 165, 21,  93,	228, 82,  181, 174, 41,	 51,  202, 251, 126,
	    193, 196, 177, 98,	9,   65,  121, 195, 172, 193, 104, 182, 20,
	    180, 12,  249, 48,	5,   228, 53,  15,  123, 136, 77,  30,	87,
	    150, 213, 51,  49,	118, 10,  54,  199, 90,	 107, 78,  3,	175,
	    191, 36,  147, 7,	1,   201, 197, 201, 119, 116, 21,  207, 102,
	    100, 181, 221, 234, 143, 189, 130, 167, 168, 210, 126, 216, 203,
	    74,	 237, 100, 201, 70,  155, 168, 208, 76,	 56,  107, 36,	196,
	    182, 166, 26,  70,	156, 168, 65,  160, 74,	 116, 104, 19,	202,
	    212, 133, 41,  192, 86,  224, 89,  11,  139, 198, 93,  25,	185,
	    97,	 55,  59,  80,	11,  102, 36,  170, 113, 13,  239, 23,	91,
	    149, 51,  60,  80,	200, 97,  22,  192, 4,	 209, 51,  190, 7,
	    177, 191, 142, 252, 195, 105, 4,   12,  61,	 34,  108, 220, 194,
	    180, 141, 121, 18,	137, 188, 90,  41,  75,	 114, 37,  108, 12,
	    60,	 35,  79,  248, 200, 181, 92,  82,  136, 202, 167, 161, 146,
	    81,	 135, 90,  27,	190, 229, 131, 57,  8,	 164, 114, 166, 181,
	    226, 180, 74,  209, 108, 30,  112, 135, 252, 35,  241, 216, 232,
	    249, 253, 75,  178, 114, 82,  241, 38,  218, 28,  231, 106, 167,
	    50,	 49,  236, 43,	54,  210, 90,  4,   226, 53,  203, 202, 157,
	    208, 26,  79,  143, 69,  38,  230, 17,  216, 157, 146, 6,	234,
	    25,	 175, 242, 27,	187, 98,  87,  212, 220, 169, 50,  128, 55,
	    38,	 100, 170, 60,	13,  170, 233, 101, 210, 192, 153, 214, 142,
	    115, 99,  39,  49,	106, 123, 15};
	u8 expected_pk[] = {
	    153, 69,  106, 82,	163, 117, 20,  48,  26,	 139, 231, 119, 237,
	    73,	 191, 194, 52,	56,  183, 4,   148, 180, 76,  197, 231, 25,
	    109, 107, 154, 68,	128, 66,  185, 12,  140, 25,  20,  178, 106,
	    83,	 146, 61,  105, 2,   50,  82,  71,  117, 135, 244, 85,	116,
	    196, 105, 165, 198, 138, 80,  236, 119, 43,	 119, 18,  38,	201,
	    79,	 135, 51,  189, 93,  90,  6,   200, 26,	 198, 135, 226, 55,
	    153, 220, 36,  120, 154, 98,  209, 2,   85,	 202, 52,  166, 63,
	    86,	 8,   150, 6,	192, 106, 134, 112, 209, 151, 153, 102, 92,
	    62,	 77,  140, 42,	215, 88,  167, 166, 4,	 57,  144, 243, 158,
	    28,	 4,   208, 65,	23,  161, 15,  133, 111, 10,  244, 64,	186,
	    224, 119, 49,  146, 126, 220, 215, 44,  197, 66,  100, 132, 20,
	    23,	 207, 38,  198, 227, 81,  174, 198, 209, 65,  58,  28,	188,
	    155, 160, 38,  199, 200, 187, 214, 43,  67,	 63,  163, 85,	113,
	    70,	 63,  172, 136, 57,  103, 21,  157, 152, 102, 66,  137, 69,
	    165, 183, 144, 147, 56,  75,  161, 84,  117, 107, 170, 136, 180,
	    94,	 136, 23,  250, 170, 80,  139, 73,  195, 161, 194, 21,	247,
	    71,	 106, 45,  179, 167, 187, 252, 111, 167, 96,  148, 199, 22,
	    130, 0,   5,   165, 82,  176, 158, 148, 55,	 138, 245, 112, 107,
	    105, 226, 70,  196, 193, 127, 123, 233, 81,	 23,  235, 15,	21,
	    117, 162, 167, 48,	94,  132, 89,  109, 25,	 54,  160, 72,	122,
	    147, 61,  240, 154, 13,  200, 143, 174, 149, 172, 159, 194, 137,
	    95,	 102, 11,  81,	102, 83,  73,  133, 116, 195, 43,  13,	46,
	    32,	 159, 232, 186, 166, 228, 210, 169, 152, 234, 13,  182, 123,
	    91,	 138, 80,  81,	234, 50,  68,  70,  75,	 56,  196, 112, 175,
	    212, 214, 56,  72,	66,  177, 238, 200, 14,	 59,  90,  34,	191,
	    164, 150, 171, 83,	19,  55,  70,  170, 158, 154, 77,  179, 37,
	    28,	 65,  75,  162, 71,  134, 178, 108, 119, 58,  171, 171, 37,
	    152, 234, 47,  169, 247, 53,  21,  194, 156, 220, 113, 54,	180,
	    60,	 5,   187, 68,	48,  91,  67,  76,  37,	 250, 198, 32,	250,
	    104, 242, 73,  136, 62,  123, 93,  109, 149, 186, 60,  210, 127,
	    217, 80,  19,  99,	156, 156, 51,  11,  62,	 201, 211, 0,	174,
	    214, 105, 109, 139, 147, 207, 86,  206, 183, 204, 33,  252, 124,
	    119, 154, 218, 139, 26,  21,  78,  155, 106, 46,  228, 57,	31,
	    184, 89,  80,  172, 163, 112, 207, 166, 130, 253, 10,  183, 96,
	    151, 13,  121, 64,	153, 178, 57,  14,  204, 168, 83,  240, 245,
	    50,	 161, 0,   20,	173, 171, 130, 107, 4,	 192, 49,  246, 11,
	    69,	 97,  109, 32,	75,  63,  142, 53,  119, 185, 19,  105, 204,
	    28,	 157, 103, 88,	98,  154, 199, 190, 51,	 247, 132, 39,	64,
	    164, 39,  70,  57,	98,  7,	  158, 99,  112, 108, 101, 64,	104,
	    44,	 218, 120, 55,	241, 17,  198, 38,  172, 214, 70,  88,	85,
	    194, 116, 9,   224, 206, 123, 90,  169, 213, 50,  188, 98,	215,
	    192, 106, 19,  55,	204, 216, 121, 129, 72,	 129, 200, 219, 158,
	    125, 234, 140, 23,	234, 166, 76,  85,  35,	 235, 226, 198, 25,
	    252, 7,   17,  74,	163, 250, 171, 135, 130, 132, 64,  128, 26,
	    2,	 188, 101, 152, 95,  235, 10,  149, 144, 191, 219, 165, 174,
	    165, 21,  93,  228, 82,  181, 174, 41,  51,	 202, 251, 126, 193,
	    196, 177, 98,  9,	65,  121, 195, 172, 193, 104, 182, 20,	180,
	    12,	 249, 48,  5,	228, 53,  15,  123, 136, 77,  30,  87,	150,
	    213, 51,  49,  118, 10,  54,  199, 90,  107, 78,  3,   175, 191,
	    36,	 147, 7,   1,	201, 197, 201, 119, 116, 21,  207, 102, 100,
	    181, 221, 234, 143, 189, 130, 167, 168, 210, 126, 216, 203, 74,
	    237, 100, 201, 70,	155, 168, 208, 76,  56,	 107, 36,  196, 182,
	    166, 26,  70,  156, 168, 65,  160, 74,  116, 104, 19,  202, 212,
	    133, 41,  192, 86,	224, 89,  11,  139, 198, 93,  25,  185, 97,
	    55,	 59,  80,  11,	102, 36,  170, 113, 13,	 239, 23,  91,	149,
	    51,	 60,  80,  200, 97,  22,  192, 4,   209, 51,  190, 7,	177,
	    191, 142, 252, 195, 105, 4,	  12,  61,  34,	 108, 220, 194, 180,
	    141, 121, 18,  137, 188, 90,  41,  75,  114, 37,  108, 12,	60,
	    35,	 79,  248, 200, 181, 92,  82,  136, 202, 167, 161, 146, 81,
	    135, 90,  27,  190, 229, 131, 57,  8,   164, 114, 166, 181, 226,
	    180, 74,  209, 108, 30,  112, 135, 252, 35,	 241, 216, 232, 249,
	    253, 75,  178, 114, 82,  241, 38};
	ASSERT(!fastmemcmp(pk.data, expected_pk, sizeof(pk)), "pk");
	ASSERT(!fastmemcmp(sk.data, expected_sk, sizeof(sk)), "sk");
	enc(&ct, &ss_bob, &pk, &rng);
	u8 expected_ct[] = {
	    225, 53,  254, 56,	71,  189, 174, 48,  73,	 144, 151, 67,	185,
	    234, 212, 163, 180, 159, 193, 92,  39,  166, 231, 61,  24,	203,
	    227, 92,  118, 49,	21,  132, 222, 187, 187, 3,   120, 139, 9,
	    179, 39,  223, 59,	141, 88,  204, 3,   71,	 227, 14,  78,	120,
	    190, 66,  83,  52,	38,  250, 53,  66,  144, 125, 208, 93,	196,
	    132, 138, 125, 182, 48,  174, 38,  44,  114, 85,  64,  66,	66,
	    149, 152, 49,  196, 18,  25,  120, 78,  89,	 204, 154, 27,	146,
	    220, 131, 36,  66,	117, 233, 90,  75,  183, 197, 168, 253, 167,
	    100, 40,  165, 231, 126, 4,	  208, 72,  56,	 228, 99,  47,	12,
	    192, 41,  251, 90,	172, 25,  198, 196, 162, 27,  204, 87,	216,
	    149, 119, 83,  58,	178, 143, 8,   123, 168, 67,  19,  134, 75,
	    24,	 184, 108, 190, 216, 45,  122, 158, 32,	 239, 78,  49,	116,
	    248, 29,  23,  208, 156, 144, 2,   27,  144, 237, 80,  138, 165,
	    101, 96,  105, 206, 174, 207, 106, 82,  167, 235, 68,  220, 200,
	    86,	 177, 42,  127, 195, 247, 137, 186, 18,	 193, 188, 129, 211,
	    80,	 169, 119, 206, 25,  22,  170, 71,  99,	 113, 234, 128, 105,
	    124, 19,  109, 246, 101, 209, 169, 200, 73,	 47,  162, 2,	240,
	    148, 68,  146, 32,	229, 232, 157, 52,  141, 215, 187, 160, 216,
	    149, 9,   70,  217, 205, 147, 71,  248, 219, 181, 41,  65,	11,
	    150, 246, 119, 149, 221, 184, 204, 82,  253, 73,  43,  122, 145,
	    71,	 196, 162, 94,	17,  10,  186, 31,  97,	 169, 155, 140, 28,
	    66,	 94,  166, 109, 179, 176, 237, 224, 4,	 51,  217, 204, 158,
	    94,	 32,  117, 230, 226, 51,  153, 170, 158, 13,  147, 86,	118,
	    61,	 170, 168, 243, 198, 4,	  137, 215, 154, 104, 155, 43,	110,
	    129, 179, 9,   141, 140, 29,  243, 191, 92,	 188, 90,  204, 159,
	    113, 227, 166, 110, 31,  149, 98,  138, 144, 165, 241, 103, 80,
	    121, 187, 8,   153, 192, 29,  9,   255, 123, 250, 18,  154, 30,
	    37,	 232, 228, 79,	23,  0,	  119, 93,  171, 165, 72,  225, 43,
	    107, 138, 196, 227, 34,  141, 68,  163, 133, 228, 11,  116, 223,
	    112, 149, 20,  21,	182, 98,  131, 10,  194, 13,  143, 97,	141,
	    131, 8,   207, 155, 178, 254, 99,  82,  68,	 76,  88,  94,	246,
	    42,	 247, 43,  129, 247, 80,  67,  177, 29,	 190, 37,  99,	183,
	    233, 48,  97,  76,	238, 132, 167, 154, 127, 197, 4,   6,	123,
	    251, 238, 21,  64,	64,  116, 87,  93,  27,	 17,  87,  98,	234,
	    144, 72,  203, 252, 56,  44,  63,  203, 191, 42,  168, 60,	53,
	    194, 89,  138, 230, 19,  175, 75,  123, 6,	 205, 126, 129, 166,
	    244, 78,  176, 218, 176, 6,	  113, 160, 204, 123, 201, 197, 75,
	    188, 224, 94,  65,	73,  239, 182, 114, 156, 137, 59,  65,	63,
	    138, 5,   121, 238, 228, 210, 209, 126, 246, 106, 24,  187, 28,
	    39,	 131, 177, 247, 105, 117, 107, 132, 181, 185, 145, 255, 177,
	    102, 100, 179, 171, 146, 102, 91,  108, 172, 213, 121, 38,	252,
	    106, 234, 148, 6,	111, 219, 245, 165, 66,	 47,  215, 32,	59,
	    44,	 87,  129, 195, 191, 23,  132, 183, 19,	 7,   202, 245, 44,
	    72,	 106, 124, 52,	61,  7,	  10,  156, 235, 236, 236, 92,	140,
	    126, 138, 115, 240, 211, 67,  126, 245, 191, 204, 115, 142, 185,
	    240, 9,   170, 104, 74,  240, 37,  31,  87,	 57,  99,  113, 202,
	    116, 153, 191, 40,	194, 164, 143, 242, 46,	 206, 100, 21,	70,
	    73,	 230, 191, 181, 157, 45,  203, 38,  204, 97,  156, 58,	229,
	    182, 54,  241, 242, 252, 47,  40,  111, 253, 137, 69,  125, 26,
	    12,	 88,  200, 159, 128, 81,  17,  196, 203, 217, 54,  82,	75,
	    246, 191, 33,  232, 149, 190, 234, 61,  87,	 44,  38,  207, 253,
	    111, 11,  203, 48,	183, 14,  200, 154, 111, 3,   234, 208, 114,
	    221, 253, 17,  239, 26,  89,  176, 109, 254, 201, 109, 70,	219,
	    203, 76,  225, 208, 54,  3,	  101, 44,  1,	 79,  231, 240, 247,
	    38,	 113, 67,  84,	40,  169, 165, 211, 51,	 169, 3,   136, 24,
	    171, 242, 79,  216, 213, 10,  171, 10,  23,	 21,  93,  110, 126,
	    17,	 40,  128, 169, 84,  213, 202, 203, 234, 201, 134, 170, 230,
	    106, 204, 97,  60,	48,  112, 170, 189, 94,	 254, 237, 221, 180,
	    230, 59,  228, 189, 75,  23,  168, 83,  42,	 11,  230, 154, 34,
	    188};
	// for (u32 i = 0; i < sizeof(ct); i++) print("{}, ", ct.data[i]);
	(void)expected_ct;
	(void)expected_pk;
	(void)expected_sk;
	ASSERT(!memcmp(&ct, expected_ct, sizeof(ct)), "ct");
	dec(&ss_alice, &ct, &sk);
	// for (u32 i = 0; i < sizeof(ss_bob); i++) print("{}, ",
	// ss_bob.data[i]);

	ASSERT(!fastmemcmp(&ss_bob, &ss_alice, KEM_SS_SIZE), "shared secret");
	u8 expected[32] = {197, 163, 103, 82,  166, 130, 236, 92,
			   211, 38,  178, 205, 252, 196, 184, 10,
			   79,	238, 216, 19,  218, 46,	 81,  40,
			   212, 193, 102, 20,  15,  87,	 105, 175};
	ASSERT(!fastmemcmp(&ss_bob, expected, KEM_SS_SIZE), "expected");
}

Test(kem_iter) {
	KemSecKey sk;
	KemPubKey pk;
	KemCipherText ct;
	KemSharedSecret ss_bob = {0}, ss_alice = {0};
	Rng rng1, rng2;

	for (u32 i = 0; i < 1000; i++) {
		rng_init(&rng1);
		rng_init(&rng2);

		keypair(&pk, &sk, &rng1);
		enc(&ct, &ss_bob, &pk, &rng2);
		dec(&ss_alice, &ct, &sk);
		ASSERT(!fastmemcmp(&ss_bob, &ss_alice, KEM_SS_SIZE),
		       "shared secret");
	}
}

#define KEM_COUNT 10000

Bench(kempf) {
	KemSecKey sk;
	KemPubKey pk;
	KemCipherText ct;
	KemSharedSecret ss_bob = {0}, ss_alice = {0};
	Rng rng1, rng2;
	u64 keygen_sum = 0;
	u64 enc_sum = 0;
	u64 dec_sum = 0;

	for (u32 i = 0; i < KEM_COUNT; i++) {
		rng_init(&rng1);
		rng_init(&rng2);

		u64 start = cycle_counter();
		keypair(&pk, &sk, &rng1);
		keygen_sum += cycle_counter() - start;
		start = cycle_counter();
		enc(&ct, &ss_bob, &pk, &rng2);
		enc_sum += cycle_counter() - start;
		start = cycle_counter();
		dec(&ss_alice, &ct, &sk);
		dec_sum += cycle_counter() - start;
		ASSERT(!fastmemcmp(&ss_bob, &ss_alice, KEM_SS_SIZE),
		       "shared secret");
	}

	pwrite(2, "keygen=", 7, 0);
	write_num(2, keygen_sum / KEM_COUNT);
	pwrite(2, ",enc=", 5, 0);
	write_num(2, enc_sum / KEM_COUNT);
	pwrite(2, ",dec=", 5, 0);
	write_num(2, dec_sum / KEM_COUNT);
	pwrite(2, "\n", 1, 0);
}

